{% comment %} =====================
ASSETS CONFIG
===================== {% endcomment %}

{% assign css_assets = 'theme.css,custom.css,utilities.css' | split: ',' %}

{% assign deferred_css_assets = '
reviewsio.css,
kraken.css,
recharge.css,
klaviyo.css,
pagefly-custom.css,
toastr.css,
bloggle.css,
intelligems.css,
animate-4.1.1.min.css
' | split: ',' %}

{% assign js_assets = 'vendor.js,global.js,theme.js,custom.js,analytics.js,toastr.min.js' | split: ',' %}

{% assign external_css_assets = '' %}

{% comment %} =====================
META / SEO
===================== {% endcomment %}

<meta charset="utf-8">
<meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=1.0"
>
<meta name="theme-color" content="{{ settings.header_background }}">
<meta name="facebook-domain-verification" content="lfkibv0ofe5gspxnwgw91xh7pao0f4">

<title>
  {% if page_title == blank %}
    {{ shop.name }}
  {% else %}
    {{ page_title }}
    {% if current_page != 1 %} â€“ {{ 'general.meta.page' | t: page: current_page }}{% endif %}
    {% unless page_title contains 'The Female Company' %} | The Female Company{% endunless %}
  {% endif %}
</title>

{% if settings.favicon %}
  <link rel="shortcut icon" href="{{ settings.favicon | img_url: '96x96' }}" type="image/png">
{% endif %}

{% if template contains 'seo-hide' or seo_hide or current_tags.size > 0 %}
  <meta name="robots" content="noindex">
{% endif %}

{% if page_description %}
  <meta name="description" content="{{ page_description | escape }}">
{% endif %}

{% render 'canonical-url' %}
{% render 'social-meta-tags' %}
{% render 'microdata-schema' %}

{% comment %} =====================
PERFORMANCE CORE
===================== {% endcomment %}

{% render 'yett' %}
{% render 'font-render' %}

<!-- Network hints -->
<link rel="preconnect" href="https://cdn.shopify.com" crossorigin>

{% comment %} =====================
PRELOAD (ONLY CRITICAL)
===================== {% endcomment %}

<!-- Critical CSS -->
{% for css_asset in css_assets %}
  <link rel="preload" as="style" href="{{ css_asset | asset_url }}">
{% endfor %}

{% if request.page_type == 'product' %}
  <link rel="preload" as="fetch" href="{{ product.url }}.js" crossorigin>
{% endif %}

{% comment %} =====================
STYLES
===================== {% endcomment %}

{% render 'css-variables', direction: direction %}
{% render 'js-variables', direction: direction %}
{% render 'fonts' %}

{% for css_asset in css_assets %}
  <link rel="stylesheet" href="{{ css_asset | asset_url }}">
{% endfor %}

{% for css_asset in deferred_css_assets %}
  <link
          rel="preload"
          as="style"
          href="{{ css_asset | asset_url }}"
          onload="this.onload=null;this.rel='stylesheet'"
  >
  <noscript>
    <link rel="stylesheet" href="{{ css_asset | asset_url }}">
  </noscript>
{% endfor %}

{% for css_asset in external_css_assets %}
  <link rel="stylesheet" href="{{ css_asset }}">
{% endfor %}

{% comment %} =====================
USERCENTRICS (ASYNC)
===================== {% endcomment %}

<script
        id="usercentrics-cmp"
        src="https://app.usercentrics.eu/browser-ui/latest/loader.js"
        data-settings-id="TxL-NT3yJ"
        async
></script>

<script src="https://privacy-proxy.usercentrics.eu/latest/uc-block.bundle.js" defer></script>

<script>
  window.addEventListener('ucEvent', e => {
    console.log('[USERCENTRICS]', e.detail);
  });
  if (window.uc) {
    uc.deactivateBlocking(['87JYasXPF']);
  }
</script>

{% comment %} =====================
SCRIPTS (NON-BLOCKING)
===================== {% endcomment %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" defer></script>

{% for js_asset in js_assets %}
  <script src="{{ js_asset | asset_url }}" defer></script>
{% endfor %}

<!-- Ablyft (A/B) -->
<script src="https://cdn.ablyft.com/s/67024591.js" defer></script>

<!-- Intelligems (idle load) -->
<script>
  window.requestIdleCallback(() => {
    const s = document.createElement('script');
    s.type = 'module';
    s.src = 'https://cdn.intelligems.io/esm/b9bad714bc5f/bundle.js';
    document.head.appendChild(s);
  });
</script>

{% comment %} =====================
SENTRY (SAFE LOAD)
===================== {% endcomment %}

<script>
  window.addEventListener('load', () => {
    const s = document.createElement('script');
    s.src = 'https://js.sentry-cdn.com/df6c8eba46234e27a991bf672cc26a42.min.js';
    s.crossOrigin = 'anonymous';
    document.head.appendChild(s);

    s.onload = () => {
      if (!window.Sentry) return;

      Sentry.init({
        denyUrls: [
          'cdn.intelligems.io',
          'widget.reviews.io',
          'static.klaviyo.com',
          'cdn.shopify.com/shopifycloud/',
          'monorail-edge.shopifysvc.com',
          'scripting.tracify.ai',
          'usercentrics.eu'
        ],
        tracesSampleRate: 0.05
      });
    };
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const errors = document.body.innerText.match(/Liquid error(.*?):/g);
    if (!errors || !window.Sentry) return;

    errors.forEach(err => {
      Sentry.captureException(new Error(err));
    });
  });
</script>

{% comment %} =====================
SHOPIFY CONTENT FOR HEADER
===================== {% endcomment %}

{% assign modified_content_for_header = modified_content_for_header
        | replace: 's.async = true;', 's.defer = true;' %}

{{ modified_content_for_header }}

{% comment %} =====================
SHOPIFY CONSENT SYNC
===================== {% endcomment %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    Shopify.loadFeatures([{ name: 'consent-tracking-api', version: '0.1' }], () => {

      function syncConsent() {
        if (!window.UC_UI) return;

        if (!window.UC_UI || !UC_UI.isInitialized()) return;

        window.addEventListener('UC_UI_INITIALIZED', () => {
          const services = UC_UI.getServicesBaseInfo();
          const analytics = services.filter(s => s.categorySlug === 'functional').every(s => s.consent.status);
          const marketing = services.filter(s => s.categorySlug === 'marketing').every(s => s.consent.status);

          Shopify.customerPrivacy.setTrackingConsent({
            preferences: true,
            analytics,
            marketing
          });
        })
      }

      if (!UC_UI.isInitialized()) {
        window.addEventListener('UC_UI_INITIALIZED', syncConsent);
      } else {
        syncConsent();
      }

      window.addEventListener('ucEvent', e => {
        if (e.detail?.event === 'consent_status') syncConsent();
      });
    });
  });
</script>
