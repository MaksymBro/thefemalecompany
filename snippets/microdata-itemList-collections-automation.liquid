{% comment %}
  Schema.org ItemList for collection pages
  Requirements:
  - only products visible on the page (pagination, sorting, filters)
  - only valid products:
    - published
    - visible
    - at least one available variant
    - has image
    - no test/demo products
{% endcomment %}

{% if template.name == 'collection' and paginate.items > 0 %}

    {%- assign list_items = '' -%}
    {%- assign position = 0 -%}

    {% for product in collection.products %}
        {% assign product_not_variant = product %}
        {% assign product = product.selected_or_first_available_variant %}
        {%- assign skip = false -%}

        {%- if product_not_variant.metafields.custom.hide_on_storefront == true -%}
            {%- assign skip = true -%}
        {% endif %}

        {%- if product.available != true -%}
            {%- assign skip = true -%}
        {%- endif -%}

        {%- if product.featured_image == blank -%}
            {%- assign skip = true -%}
        {%- endif -%}

        {%- assign title_downcase = product.title | downcase -%}
        {%- if title_downcase contains 'test'
        or title_downcase contains 'demo'
        or title_downcase contains 'sample' -%}
            {%- assign skip = true -%}
        {%- endif -%}

        {%- if skip == false -%}
            {%- assign position = position | plus: 1 -%}

            {%- capture item -%}
                {
                "@type": "ListItem",
                "position": {{ position }},
                "url": {{ product.url | absolute_url | json }},
                "item": {
                "@type": "Product",
                "name": {{ product.title | json }},
                "url": {{ product.url | absolute_url | json }},
                "image": {{ product.featured_image | image_url: width: 1200 | prepend: 'https:' | json }},
                "offers": {
                "@type": "Offer",
                "price": "{{ product.price | money_without_currency | replace: ',', '.' }}",
                "priceCurrency": {{ shop.currency | json }},
                "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
                }
                }
                }
            {%- endcapture -%}

            {%- if list_items != '' -%}
                {%- assign list_items = list_items | append: ',' -%}
            {%- endif -%}

            {%- assign list_items = list_items | append: item -%}

        {%- endif -%}

    {% endfor %}

    {% if position > 0 %}
        <script type="application/ld+json">
            {
              "@context": "https://schema.org",
              "@type": "ItemList",
              "name": {{ collection.title | json }},
  "url": {{ canonical_url | json }},
  "description": {{ collection.description | strip_html | truncate: 300 | json }},
  "itemListOrder": "https://schema.org/ItemListOrderAscending",
  "numberOfItems": {{ position }},
  "itemListElement": [
            {{ list_items }}
            ]
          }
        </script>
    {% endif %}

{% endif %}
