{% assign base_url = canonical_url | split:'?' | first %}
{% assign parts = base_url | split:'/' %}
{% assign locale_part = parts[3] %}

{%- if locale_part contains '-' -%}
    {% assign lang = locale_part | split:'-' | first %}
{%- else -%}
    {% assign lang = locale_part %}
{%- endif -%}

{%- comment -%}
If main language (de) â†’ canonical without locale
{%- endcomment -%}

{% if lang == 'de' %}
    {% assign canonical = parts[0] | append: '//' | append: parts[2] %}
{% else %}
    {% assign canonical = parts[0] | append: '//' | append: parts[2] | append: '/' | append: lang %}
{% endif %}

{% for part in parts offset:4 %}
    {% assign canonical = canonical | append: '/' | append: part %}
{% endfor %}

<link rel="canonical" href="{{ canonical }}">
