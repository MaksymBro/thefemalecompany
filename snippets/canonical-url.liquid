{% assign base_url = canonical_url | split:"?" | first %}
{% assign protocol_and_domain = base_url | split:"/" | slice:0,3 | join:"/" %}
{% assign full_path = base_url | remove: protocol_and_domain %}
{% assign raw_parts = full_path | split:"/" %}
{% assign path_parts = "" | split:"" %}

{% for p in raw_parts %}
    {% unless p == "" %}
        {% assign path_parts = path_parts | push: p %}
    {% endunless %}
{% endfor %}

{% if path_parts.size > 0 %}
    {% assign first = path_parts[0] %}
    {% if first.size == 2 or first contains "-" %}
        {% assign path_parts = path_parts | slice: 1, path_parts.size %}
    {% endif %}
{% endif %}

{% assign cleaned_path = path_parts | join:"/" %}
{% assign final_url = protocol_and_domain | append:"/" | append: cleaned_path %}

<link rel="canonical" href="{{ final_url }}">
